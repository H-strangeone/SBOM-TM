name: SBOM-TM Security Scan
on:
  push:
    branches: [ main, master ]
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  scan:
    name: Run SBOM-TM scan/diff
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install sbom-tm
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Run SBOM diff (compare HEAD against merge-base)
        id: run_diff
        run: |
          set -e
          PROJECT="${{ github.sha }}"
          sbom-tm diff --git --project "${PROJECT}"

      - name: Locate markdown diff report
        id: find_report
        run: |
          set -e
          # look for the most recent markdown diff report
          REPORT="$(ls ~/.cache/sbom-tm/reports/*_sbom_diff.md 2>/dev/null | head -n1 || true)"
          if [ -z "$REPORT" ]; then
            echo "No report found"
            echo "report_path=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Found report: $REPORT"
          echo "report_path=$REPORT" >> $GITHUB_OUTPUT

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-diff-report
          path: ${{ steps.find_report.outputs.report_path }}
          if-no-files-found: warn

      - name: Post sticky PR comment (report)
        if: ${{ steps.find_report.outputs.report_path != '' && github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: ${{ steps.find_report.outputs.report_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
name: SBOM Security Scan

on:
  pull_request:
    paths:
      - "**/*"
  push:
    branches:
      - main

jobs:
  sbom_scan:
    name: Run SBOM + Trivy + RuleEngine Scan
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # CHECKOUT SOURCE CODE
      # -------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------------
      # INSTALL PYTHON
      # -------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------------------------------
      # INSTALL SBTM-TM TOOL
      # -------------------------------
      - name: Install SBOM-TM tool
        run: |
          pip install -r requirements.txt
          pip install .

      # -------------------------------
      # INSTALL SYFT
      # -------------------------------
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0.16.0

      # -------------------------------
      # GENERATE SBOM
      # -------------------------------
      - name: Generate SBOM using Syft
        run: |
          syft . -o cyclonedx-json > sbom.json

      # -------------------------------
      # INSTALL TRIVY
      # -------------------------------
      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.4.0

      # -------------------------------
      # RUN SBOM-TM SCAN (Trivy + Rules)
      # -------------------------------
      - name: Run SBOM Scan
        id: sbomtm
        run: |
          sbom-tm scan --sbom sbom.json --project "${{ github.event.repository.name }}" --offline
        continue-on-error: true

      # -------------------------------
      # UPLOAD REPORTS (HTML + JSON)
      # -------------------------------
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: sbom-security-reports
          path: |
            ~/.cache/sbom-tm/reports/*.html
            ~/.cache/sbom-tm/reports/*.json
          if-no-files-found: warn

      # -------------------------------
      # FAIL PR IF THREATS FOUND
      # Your tool prints:
      # "threats=<count>"
      # -------------------------------
      - name: Block PR if threats > 0
        if: steps.sbomtm.outcome == 'failure'
        run: |
          echo "❌ Threats detected! Blocking PR."
          exit 1

      - name: Success message
        if: steps.sbomtm.outcome == 'success'
        run: echo "✔ No threats found. Safe to merge!"
